<!DOCTYPE html>
<html>
<head>
<title>Tranfusion Mapping</title>

<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script> 
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
<!--
DO WE NEED THESE?
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
//-->
<style>
html{color:#000;background:#FFF}body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,code,form,fieldset,legend,input,textarea,p,blockquote,th,td{margin:0;padding:0}table{border-collapse:collapse;border-spacing:0}fieldset,img{border:0}address,caption,cite,code,dfn,em,strong,th,var{font-style:normal;font-weight:normal}li{list-style:none}caption,th{text-align:left}h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:normal}q:before,q:after{content:''}abbr,acronym{border:0;font-variant:normal}sup{vertical-align:text-top}sub{vertical-align:text-bottom}input,textarea,select{font-family:inherit;font-size:inherit;font-weight:inherit}input,textarea,select{font-size:100%}legend{color:#000}

a {
	text-decoration: none;
	color: #fff;
}
window{
	height:100%;
}
body,html,#content{
	font-family:Arial;
	height:100%;
	width:100%;
}
#content{
	position:absolute;
	z-index:1;
	overflow:hidden;
}
#navigation{
	position:absolute;
	top:0px;
	z-index:10;
	width:100%;
	background-color:#AAA;
	border-bottom:solid #EEA41F 4px;
}
#navigation ul, .sub-nav ul{border:none;padding:0px;margin:0px;}
#navigation li{
	padding:8px 15px 5px 15px;
	margin:0px;
	list-style:none;
	
	font-size:14px;
	font-weight:bold;
	color:#FFF;
	
	display:inline-block;
	cursor:pointer;
}
#navigation li.active{
	background-color:#EEA41F;
}
#navigation li:hover{
	/*background-color:#EEA41F;*/
}
#map-container,#login-container,#pending-container, #mselect-container{
	width:100%;
	height:100%;
	margin-top:40px;
}

/*sub navigations*/
.sub-nav ul{
	padding-top:40px;
	background-color:#EEA41F;
}
.sub-nav li{
	padding:3px 8px;
	margin:2px 0px 4px 4px;
	list-style:none;
	
	font-size:8px;
	font-weight:bold;
	color:#FFF;
	
	display:inline-block;
	cursor:pointer;
}
.sub-nav li.active{
	background-color:#333;
}

/*form stuff*/
.inner{
	padding:10px;
}
form .title{
	font-weight:bold;
	font-size:12px;
	color:#EEA41F;
	padding:0px;
	margin:0px;
	line-height:16px;
	width:auto;
}
form .dropdown{
	font-weight:bold;
	font-size:12px;
	color:#000000;
	padding:5px;
	margin:0px;
	line-height:16px;
	width:125px;
}
input, select{
	font-size:14px;
	color:#FFF;
	background-color:#AAA;
	border:none;
	font-weight:bold;
	width:135px;
	padding:5px;
	
}
.round{
	border-radius:3px;
	-moz-border-radius:3px;
}
input.btn{
	padding:4px;
	font-size:12px;
	font-weight:bold;
	color:#FFF;
	background-color:#333;
	border:solid #333 2px;
	cursor:pointer;
}
input.btn:hover{
	border-top:solid #555 2px;
	border-left:solid #555 2px;
	border-bottom:solid #000 2px;
	border-right:solid #000 2px;
	background-color:#555;
}
#data-data-form li{
	padding:0px 0px 8px 0px;
}
#data-data-form input, select{
	width:75px;
	margin-right:8px;
}
#data-data-form select{
	width:150px;
}
.grad-grey{
	background-image: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#CCC), to(#222));
	background-image: -webkit-linear-gradient(top, #CCC, #222); 
	background-image: -moz-linear-gradient(top, #CCC, #222);
	background-image: -ms-linear-gradient(top, #CCC, #222);
	background-image: -o-linear-gradient(top, #CCC, #222);
}

.infoWindow input{
	margin-top:10px;
	border-radius:3px;
	-moz-border-radius:3px;
	cursor:pointer;
	
	border-right:solid transparent 2px;
	border-bottom:solid transparent 2px;
	
	font-size:12px;
}
.infoWindow input:hover{
	border-right:solid black 2px;
	border-bottom:solid black 2px;
}

/* PENDING CHANGES PAGE */
#pending-container .btn{
	width:auto;
}
#pending-container{
	width:500px;
	margin-left:auto;
	margin-right:auto;
	overflow:auto;
	font-size:12px;
}
#pending-container-inner{
	padding-bottom:15px;
}
#pending-container-inner input{
	margin:0px;
	padding:0px;
	margin-right:10px;
	width:20px;
	height:15px;
}
#pending-container-inner .wrapper{
	padding-top:15px;
}
#pending-container-inner .head{
	font-weight:bold;
}
#pending-container-inner .header{
	border-top:solid #EEA41F 2px;
	border-bottom:solid #000 2px;
}
#pending-container-inner .header .child{
	width:160px;
	display:inline-block;
	float:left;
	overflow:hidden;
	border:solid #FFF 1px;
}
#pending-container-inner .body .child{
	width:160px;
	display:inline-block;
	float:left;
	overflow:hidden;
	padding-top:10px;
	border:solid #FFF 1px;
}
#pending-container-inner .diff{
	background-color:#CCC;
	cursor:pointer;
}
#mapselect{
	width:auto;
}
#data-header li{
	display:inline-block;
	text-align:center;
	font-size:14px;
}
</style>

</head>
<body>
<div id="navigation" class="">
	<ul>
		<li id="mselect">Map Select</li><li id="map" class="active">Map</li><li id="data">Data Sheet</li><li id="pending">Pending Changes</li><li><a id="login" class="ignore">Login/Logout</a></li>
	</ul>	
</div>
<div id="content">
	<div id="map-container">
	</div>
	<div class="inner" id="mselect-container" style="display:none;">
		<div style="margin:0px auto;max-width:400px;">
			<form name="drop_list">
				<div class="title">LOCATIONS</div>
				<select name ="mapselect" id="mapselect" class="dropdown">
				</select>
				
			</form>
		</div>
	</div> 
	
	<div id="data-container" style="display:none;">
		<div class="inner" id="data-container" style="margin:40px auto 0px auto;max-width:600px;">
			<form id="data-form">
				<input type="hidden" name="LineID" id="LineID" value="" />
				<input type="hidden" name="UPDATED_BY" id="UPDATED_BY" value="" />
				<input type="hidden" name="UPDATED_DATE" id="UPDATED_DATE" value="" />
				
				<div style="float:left;width:50%">
					<div class="title">SURVEY</div>
					<input class="round" type="text" name="SURVEY" id="SURVEY" />
					
					<div class="title">FROM</div>
					<input class="round" type="text" name="FROM" id="FROM" />
					
					<div class="title">TO</div>
					<input class="round" type="text" name="TO" id="TO" />
				</div>
				
				<div style="float:right;width:50%">
					<input type="hidden" name="inspector" id="inspector" />
					
					<div class="title">SECTION WIDTH</div>
					<input class="round" type="text" name="sectionwidth" id="WIDTH" />
					
					<div class="title">SECTION HEIGHT</div>
					<input class="round" type="text" name="sectionheight" id="LENGTH" />
					
					<div class="title">DATE INSPECTED</div>
					<input class="round" type="text" name="dateinspected" id="UPDATED_DATE" />
				</div>
				<div style="clear:both"></div>
			
				<div style="margin:10px auto 0px auto;max-width:600px">
				<ul id="data-header">
					<li style="width:155px;"><div class="title">DATA</div></li>
					<li style="width:85px;">High</li>
					<li style="width:85px;">Medium</li>
					<li style="width:85px;">Low</li>
				</ul>
				<div id="data-data-form">
					<ul id="data-data-elements"></ul>
					<input id="data-data-add" type="button" class="round btn" style="width:auto;" value="Add Entry +" />
					<input id="data-data-save" type="button" class="round btn save" style="width:auto;" value="Save" />
				</div>
				</form>
			</div>
		</div>
	</div>
<!--
	<div class="inner" id="login-container" style="display:none;">
		<div style="margin:0px auto;max-width:400px;">
			<form>
				<div class="title">EMAIL</div>
				<input class="round" type="text" name="email" />
				
				<div class="title">PASSWORD</div>
				<input class="round" type="password" name="password" />
				
				<div style="margin-top:8px;">
					<input type="button" value="Login" class="round btn" />
				</div>
			</form>
		</div>
	</div>
-->
	<div class="inner" id="pending-container" style="display:none">
		<div id="pending-container-inner"></div>
		<input type="button" class="round btn" value="Push Selected" id="pending-push" />
		<input type="button" class="round btn" value="Delete Selected" id="pending-delete" />
	</div>
</div>

<script>
$(document).ready(function(){
/**
 * This is the datamap used when a user decides to edit data
 */
var dataMap = {
		header : {
		'LineID':'',
		'FROM':'',
		'TO':'',
		'WIDTH':'',
		'LENGTH':'',
		'SURVEY':'',
		'UPDATED_BY':'',
		'UPDATED_DATE':'',
		//'geometry':'',
		//'COMMENT':'',
		},
		images : {
		'SITE_IMAGE_1':'',
		'SITE_IMAGE_2':'',
		'SITE_IMAGE_3':'',
		},
		data : {
			'ALLIG' : {
				code : 1,
				name : 'Alligator Cracking'
			},
			'BLEED' : {
				code : 2,
				name : 'Bleeding'
			},
			'BLOCK' : {
				code : 3,
				name : 'Block Cracking'
			},
			'BUMP' : {
				code : 4,
				name : 'Bumps and Sags'
			},
			'CORRU' : {
				code : 5,
				name : 'Corrugation',
			},
			'DEPRE' : {
				code : 6,
				name : 'Depression',
			},
			'EDGE' : {
				code : 7,
				name : 'Edge Cracking',
			},
			'REFLE' : {
				code : 8,
				name : 'Jt. Reflection Cracking'
			},
			'LANE' : {
				code : 9,
				name : 'Lane/Shoulder Drop Off'
			},
			'LONG' : {
				code : 10,
				name : 'Long &amp; Trans Cracking'
			},
			'PATCH' : {
				code : 11,
				name : 'Patch &amp; Util Cut Patching'
			},
			'POLIS' : {
				code : 12,
				name : 'Polished Aggregate'
			},
			'POTHO' : {
				code : 13,
				name : 'Potholes Count',
			},
			'BRCRO' : {
				code : 14,
				name : 'Railroad Crossing'
			},
			'RUTT' : {
				code : 15,
				name : 'Rutting'
			},
			'SHOV' : {
				code : 16,
				name : 'Shoving'
			},
			'SLIP' : {
				code : 17,
				name : 'Slippage Cracking'
			},
			'SWELL' : {
				code : 18,
				name : 'Swell'
			},
			'WEATH' : {
				code : 19,
				name : 'Weathering/Ravelling'
			},
		},
	};
	
	/**
	 * A wrapper for all functions
	 */
	var main = {
		//reference to the navigation
		$navs: null,
		
		//reference to the most recently clicked
		//navigation tab
		$current: null,
		
		$mapWrapper: null,
		
		//called on document load
		init:function(){
			var obj = this;
			obj.$navs = $('#navigation li');
			
			obj.$mapWrapper = $('#map-container');
			
			//main navigation
			obj.$navs.filter(':not(.ignore)').click(function(){
				var $local = $(this);
				obj.$current = $(this);
				
				$('#'+obj.$navs.filter('.active').attr('id')+'-container').hide();
				
				$('#'+$local.attr('id')+"-container").show();
				
				if($local.attr('id') == "map"){
					//the map may not have rendered, so just hide error
					try{
						google.maps.event.trigger(obj.map, 'resize');
					}catch(e){
						//do nothing
					}
				}
				
				obj.$navs.removeClass('active');
				$local.addClass('active');
				
				obj.saveState.call(obj);
				
			});
			
			//subnavigations
			$("#data-nav li").click(function(){
			
				$(this).parent().find('li').removeClass('active');
				$(this).addClass('active');
				
				var id = $(this).attr('id')+'-container';
				
				$(this).parent().parent().parent().find('.inner').each(function(){
					if($(this).attr('id') == id){
						$(this).show();
					}else{
						$(this).hide();
					}
				});
			});
			
			//specific click event for #pending
			$('#pending').click(function(){
				main.htmlShowPendingChanges();
			});
			$('#pending-delete').click(function(){
				main.htmlPendingDelete();
			});
			$('#pending-push').click(function(){
				main.htmlPendingPush();
			});
			
			main.setLogin();
			$('#login').click(function(){
				main.doLogin();
			});
			
			//add new data entries
			$('#data-data-add').click(obj.htmlAddRecord);
			
			//save updated data entries
			$('#data-data-save').click(obj.htmlSaveRecord);
			
			//build HTML list
			this.$htmlDD = $(document.createElement('select')).addClass('round');
			for(var x in dataMap.data){
				var $temp = $(document.createElement('option'));
				$temp.val(dataMap.data[x].code).html(dataMap.data[x].name);
				this.$htmlDD.append($temp);
			}
			
			//build the Delete button
			this.$htmlDelete = $(document.createElement('input'))
				.attr('class','round btn')
				.val('Delete').attr('type','button');
			
			obj.restoreState();
		},
		setLogin : function(){
			if(main.isLoggedIn()){
				$('#login').html('Logout');
			} else {
				$('#login').html('Login');
			}
		},
		isLoggedIn : function(){
			var loggedin = false;
			if(typeof sessionStorage.loginExpire == "string"){
				var expire = parseInt(sessionStorage.loginExpire);
				var time = new Date().getTime() / 1000;
				loggedin = (expire > time);
			}
			return loggedin;
		},
		doLogin : function(){
			if(main.isLoggedIn()){
				main.logout();
			} else {
				main.login();
			}
		},
		login : function(){
			
			var temp = window.location.pathname.split('/');
			temp.pop();
			temp = temp.join('/');
			
			
			var url = 'https://accounts.google.com/o/oauth2/auth' + '?' + $.param({
				client_id: '117853050345.apps.googleusercontent.com',
				response_type: 'token',
				redirect_uri: 'http://'+document.domain + temp + '/callback.php',
				scope: 'https://www.googleapis.com/auth/fusiontables'
			});
			document.location.href=url;
		},
		logout : function(){
			delete(sessionStorage.login);
			delete(sessionStorage.loginExpire);
			$('#login').html('Login');
			alert('You have been logged out.');
		},
		//HTML drop down list for data
		$htmlDD : null,
		
		//delete button for data
		$htmlDelete : null,
		
		//HTML drop down list for maps choices
		$htmlDDmap : $(document.drop_list.mapselect),
		
		//add a record for input to the data
		htmlAddRecord : function(){
			var $ul = $('#data-data-elements');
			var id = $ul.children().length;

			var newElsNames = ['distcode','L','M','H'];
			
			var $li = $(document.createElement('li'));
			$li.attr('id','data-entry-'+id);
			
			//create the DL
			main.$htmlDD.clone().attr('id','distcode-'+id).appendTo($li);
			
			for(x=1; x<newElsNames.length; x++){
				var $temp = $(document.createElement('input'));
				$temp.attr('id',newElsNames[x] + '-' + id).attr('class','round');
				$li.append($temp);
			}
			
			//add the delete
			$li.append(main.$htmlDelete.clone().click(function(){$(this).parent().remove();}));
			
			$ul.append($li);
			return $li;
		},
		
		/**
		 * Save the current record values to local data store.
		 * Event is bound to the save button click
		 */
		htmlSaveRecord : function(){
			var data = main.getCurrentData();
			if(data.LineID != ""){
				main.localData.records[data.LineID] = data;
				main.saveState();
				alert('Data Saved.  See "Pending Changes" to finalize changes.');
			}
		},
		
		/**
		 * Add a record for data, and set record values
		 * @param code int The corresponding code from dataMap.code
		 * @param l string The low value
		 * @param m string The medium value
		 * @param h string The high value
		 * @param fromFusion boolean If this is a fusion record or local record
		 */
		htmlAddRecordData : function(code,l,m,h, fromFusion){
			var $li = this.htmlAddRecord();
			
			if(fromFusion){
				$li.children().first().val(code).next().val(l).next().val(m).next().val(h);
			} else {
				$li.addClass('local').children().first().val(code).next().val(l).next().val(m).next().val(h);
			}
		},
		
		/**
		 * Builds the html for pending changes page
		 */
		htmlShowPendingChanges : function(){
			var $cont = $('#pending-container-inner');
			var $clear = $(document.createElement('div')).attr('style','clear:both');
			
			$cont.empty();
			
			var opts = ['_L','_M','_H'];
			
			for(var x in main.localData.records){
				var $cbox = $(document.createElement('input')).attr('type','checkbox').val(x).attr('checked','true');
				var $wrap = $(document.createElement('div')).addClass('wrapper');
				var record = main.localData.records[x];
				var orig = main.localData.origs[x];
			
				//x is the LineID
				$h = $(document.createElement('div')).addClass('head');
				$h.append($cbox).append('<span>LineID: '+x+'</span>');
				$head = $(document.createElement('div')).addClass('header');
				$body = $(document.createElement('div')).addClass('body');
				
				for(var y in dataMap.header){
					var str = y + ':' + record[y];
					var $div = {};
					
					if(orig[y] != record[y] && !(typeof orig[y] == 'undefined' && record[y] == '')){
						var temp = (typeof orig[y] == 'undefined'
										|| orig[y] == ''
									) ? 'N/A' : orig[y];
						$div = $(document.createElement('div')).addClass('child').
							attr('title',temp).addClass('diff').click(function(){
								var temp = $(this).attr('title');
								alert('origional value: '+temp);
							});
					} else {
						$div = $(document.createElement('div')).addClass('child');
					}
					$div.html(str);
					$head.append($div);
				}
				
				for(var y in dataMap.data){
					if(	(
						(typeof record[y+'_L'] != 'undefined' && (record[y+'_L'] != '')) ||
						(typeof record[y+'_M'] != 'undefined' && (record[y+'_M'] != '')) ||
						(typeof record[y+'_H'] != 'undefined' && (record[y+'_H'] != ''))
						) 
					){
						for(var i in opts){
							var str = y + opts[i] + ':' + record[y+opts[i]];
							var $div = {};
							if( orig[y+opts[i]] != record[y+opts[i]]
								&& !(typeof orig[y+opts[i]] == 'undefined' && record[y+opts[i]] == '')
							){
								var temp = (typeof orig[y+opts[i]] == 'undefined'
										|| orig[y+opts[i]] == ''
									) ? 'N/A' : orig[y+opts[i]];
								
								$div = $(document.createElement('div')).addClass('child').
									addClass('diff').attr('title',temp).click(function(e){
										var temp = $(this).attr('title');
										alert('origional value: '+temp);
									});
							} else {
								$div = $(document.createElement('div')).addClass('child');
							}
							$div.html(str);
							$body.append($div);
						}
					}
				}
				
				if($body.html() == '') $body.html('NO DATA');
				
				$head.append($clear.clone());
				$body.append($clear.clone());
				
				$wrap.append($h);
				$wrap.append($head);
				$wrap.append($body);
				
				$cont.append($wrap);
			}
			
		},
		/**
		 * Private method for get all selected pending elements
		 */
		_getSelectedPending : function(){
			return $('#pending-container-inner input:checked');
		},
		/**
		 * Push/Save selected pending changes
		 */
		htmlPendingPush : function(){
			$pendings = main._getSelectedPending();
		},
		
		/**
		 * Delete selected pending changes
		 */
		htmlPendingDelete : function(){
			$pendings = main._getSelectedPending();
			window.X = $pendings;
			$pendings.each(function(){
				id = $(this).val();
				
				//remove from local datastore
				delete(main.localData.records[id]);
				main.saveState();
				
				//remove the HTML element
				$(this).parent().parent().detach();
			})
		},
		
		/**
		 * Remove an HTML entry from data list
		 * @param id Int the unique id for the element
		 * @TO-DO When you delete an element, the "missing data" will not be shown in the diff
		 */
		htmlRemoveRecord : function(id){
			var wrapper = '#data-entry-'+id;
			var $ul = $('#data-data-elements').find(wrapper).detach();
		},
		
		/**
		 * Removes all elements from the data list
		 */
		htmlRemoveAllRecords : function(){
			$('#data-data-elements').empty();
		},
		
		/**
		 * Private object for holding id=>field_name of dataMap.data object.
		 */
		_cacheCrackById : {},
		
		/**
		 * Get the crack type drop down list id value to fusion map field name
		 * @param id Integer Id of the dataMap.data.<field name>.id
		 */
		_getCrackTypeById : function(id){
			if(typeof this._cacheCrackById.length == 'undefined'){
				for(var x in dataMap.data){
					this._cacheCrackById[dataMap.data[x].code] = x;
				}
			} 
			return this._cacheCrackById[id];
		},
		/**
		 * Get the current information about data
		 * @return JSON {<field name>:<value>...}
		 * @see dataMap object
		 */
		 getCurrentData : function(){
			var data = {};
			
			//get the header information
			for(var x in dataMap.header){
				data[x] = $('#'+x).val();
			}
			
			//get the body elements
			$('#data-data-elements li').each(function(){
				//row from <ul> wrapper
				var $el = $(this);
				
				//get the drop down list value
				var typeId = $el.find('select').val();
				var typeCrack = main._getCrackTypeById(typeId);
				
				//get the inputs values
				var inputs = $el.find('input');
				var low = $(inputs[0]).val();
				var med = $(inputs[1]).val();
				var high= $(inputs[2]).val();
				
				data[typeCrack+'_L'] = low;
				data[typeCrack+'_M'] = med;
				data[typeCrack+'_H'] = high;
				
			});
			
			//add missing entries
			var opts = ['_L','_M','_H'];
			for(var x in dataMap.data){
				for(var y in opts){
					if(typeof data[x+opts[y]] == 'undefined'){
						data[x+opts[y]] = "";
					}
				}
			}
			
			return data;
		 },
		
		/**
		 * Initializes the map choices.  All parameters are optional
		 * but if lat is set, it is expected that lgt and callback are 
		 * also set.
		 *
		 * Performs 2 different operations
		 * - If lat is set:
		 *   + Order list based on closest to lat and lgt given
		 * - If lat undefined
		 *   + Order based on however fusion tables returns query
		 */
		initHtmlMapOptions : function(lat,lgt,callback){	
		
			if(typeof lat == "undefined" || typeof lgt == "undefined"){
				var query = "SELECT FusionID, CenterPoint, LocationName FROM 3004080";
			} else {
				var query = "SELECT FusionID, CenterPoint, LocationName FROM 3004080 ORDER BY ST_DISTANCE(CenterPoint, LATLNG("+lat+","+lgt+")) ASC"
			}
			var query = "SELECT FusionID, CenterPoint, LocationName FROM 3004080";
			var queryUrlHead = "https://www.google.com/fusiontables/api/query?sql=";
			var queryUrlTail = '&jsonCallback=?';
			var queryurl = encodeURI(queryUrlHead + query + queryUrlTail);
			
			var dataHandler = function(d) 
			{
				// data[x][0] is the fusionID, data[x][1] is the centerpoint, data[x][2] is the text name of each entry
				var data = d.table.rows; 
				
				main.$htmlDDmap.empty();
				
				var optn = document.createElement("OPTION");
				optn.text = "Choose Location";
				optn.value = 0;
				main.$htmlDDmap.append(optn);
				
				for (var x in data) 
				{
					var optn = document.createElement("OPTION");
					optn.text = data[x][2];
					optn.value = data[x][0]+'*'+data[x][1];
					main.$htmlDDmap.append(optn);
				}
				if(typeof callback != "undefined"){
					callback();
				}
			};
			// makes the actual query
			var jqxhr = $.get(queryurl, dataHandler, "jsonp");
		},
		/**
		 * Binds the map selection drop down list change event
		 * Fusion table initialization happens on this change
		 * @see initFusionLayer()
		 */
		bindHtmlMapChange : function(){
			//bind the click options
			this.$htmlDDmap.change(function (e) {
				selectedfusion = $(this).find('option:selected').val();
				
				//this is the "Select Location" option
				if(selectedfusion == 0) return;
				
				// get the correct set of coords from the coord array
				var info = selectedfusion.split('*');
				var fusionId = info[0];
				var splitcoords = info[1].split(',');
				var lat = splitcoords[0];
				var lng = splitcoords[1];
				
				main.$navs.filter("#map").trigger('click'); // make this happen from new page
								
				var city = new google.maps.LatLng(lat,lng);
				main.map.panTo(city);
				
				main.initFusionLayer(fusionId);
			});
		},
		
		/**
		 * Designed to restore last state based on sessionData and
		 * localStorage.  Not fully implamented.
		 * @see saveState()
		 * @TO-DO Add all the Map stuff
		 */
		restoreState:function(){
		
			//get the data
			if(typeof sessionStorage.sessionData == 'string'){
				this.sessionData = JSON.parse(sessionStorage.sessionData);
			}
			if(typeof localStorage.update == 'string'){
				this.localData.records = JSON.parse(localStorage.update);
			}
			if(typeof localStorage.orig == 'string'){
				this.localData.origs = JSON.parse(localStorage.orig);
			}
			
			$('#'+this.sessionData.navActive).trigger('click');
			
		},
		/**
		 * Should take a snapshot and store this locally
		 * @see restoreState()
		 */
		saveState:function(){
			//store the data in local object
			this.sessionData.navActive = this.$current.attr('id');
			
			//write to the session Data
			sessionStorage.sessionData = JSON.stringify(this.sessionData);
			
			//write localData to data store
			localStorage.update = JSON.stringify(this.localData.records);
			localStorage.orig = JSON.stringify(this.localData.origs);
		},
		
		/**
		 * This is a local data store for this session
		 */
		sessionData : {
			navActive : null,
		},
		
		/**
		 * Data is stored in this object
		 * Used by the froms for before push
		 */
		localData : {
			/**
			 * Modified records are stored here
			 * format:
			 *     {<LineID>:{LineID:<LineID>,ALLIG_L,ALLIG_M,ALLIG_M....FIELD36_H},...}
			 */
			records : {},
			/**
			 * Origional data records from fusion mapped.
			 * Populated when the "Edit" button is clicked
			 * format:
			 *     {<LineID>:{LineID:<LineID>,ALLIG_L,ALLIG_M,ALLIG_M....FIELD36_H},...}
			 */
			origs : {}
		},
		
		/**
		 * Looks for users position.  Has success or failure.
		 * @see setLocationCallback() This is the on success
		 * @see getLocationFailed() This is on error
		 */
		initLocation : function(){
			navigator.geolocation.
				getCurrentPosition(main.setLocationCallback,main.getLocationFailed);
		},
		/**
		 * Holds google marker object representing users position
		 */
		marker : null,
		
		/**
		 * The max distance marker should be from closest position
		 * and still center map to the user
		 */
		maxMarkerDist : 10, //miles
		
		/**
		 * This is the callback function for setting location for
		 * user on the map.
		 * @param position The system position returned
		 * @see initLocation() Scope of this function
		 * @see watchLocation() Called at end.
		 * @see http://www.w3.org/TR/geolocation-API/#geolocation_interface
		 */
		setLocationCallback : function(position){
			
			//reset the menu to be ordered
			var lat = position.coords.latitude;
			var lgt = position.coords.longitude;
			main.initHtmlMapOptions(lat,lgt,
				function(){
					var fusionId = main.$htmlDDmap.children().first().next().val().split('*')[0];
					main.initFusionLayer(fusionId);
					
					//check the distance and determine if there is a reason to locate map
					//to current user position
					var mapPos = main.map.getCenter();
					var dist = main.distanceBetweenPoints(lat,lgt,mapPos.lat(),mapPos.lng());
					
					//bail if the user is nowhere near anything
					if(dist > main.maxMarkerDist) return;
					
					var loc = new google.maps.LatLng(lat,lgt);
					main.map.panTo(loc);
					
					main.marker = new google.maps.Marker({
						draggable:false,clickable:false,position:loc
					});
					
					main.marker.setMap(main.map);
					
					main.watchLocation();
				}
			);
		},
		/**
		 * Calculate the length between 2 points given lat and long
		 * @param lat1 float First points latitude
		 * @param lon1 float First points longitude
		 * @param lat1 float Second points latitude
		 * @param lon1 flaot Second points longitude
		 * @return float The arc distance between 2 given points
		 */
		distanceBetweenPoints : function(lat1,lon1,lat2,lon2){
			var R = 3963; // miles
			var dLat = (lat2-lat1) * 3.14/180;
			var dLon = (lon2-lon1) * 3.14/180;
			var lat1 = lat1 * 3.14/180;
			var lat2 = lat2 * 3.14/180;

			var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
					Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
			return R * c;
		},
		/**
		 * If a position for user is found, then this is called.
		 * Updates the marker.
		 * @see marker
		 * @see setLocationCallback() Scope of this funcitno
		 */
		watchLocation : function(){
			navigator.geolocation.watchPosition(function(position){
				var lat = position.coords.latitude;
				var lgt = position.coords.longitude;
				var loc = new google.maps.LatLng(lat,lgt);
				main.marker.setPosition(loc);
			}, main.getLocationFailed);
		},
		/**
		 * Handles errors from attempting to find user location.
		 * @see watchLocation()
		 * @see initLocation()
		 */
		getLocationFailed : function(error){
			switch(error.code)  
            {  
                case error.PERMISSION_DENIED: 
				//user did not share location, do nothing
                break;  
  
                case error.POSITION_UNAVAILABLE: 
                //could not locate current position
                break;  
  
                case error.TIMEOUT: 
				//timeout error
                break;  
  
                default: 
                //unknown error
                break;  
            }
		},
		/**
		 * The google map
		 */
		map:null,        //the google map
		
		/**
		 * Currently loaded fusion table
		 */
		fusion:null,     //the fusion layer
		
		/**
		 * Customized popup window
		 */
		mapWindow:null, //the popup window in map
		
		/**
		 * Initializes the google map.
		 * @TO-DO Set the initial locaiton to headquarters
		 */
		initMap : function(){
			var city = new google.maps.LatLng(42.8576698303223,-106.267807006836);
			
			this.map = new google.maps.Map(main.$mapWrapper[0], {
				center: city,
				zoom: 17,
				mapTypeId: google.maps.MapTypeId.ROADMAP,
				zoomControlOptions: {style: google.maps.ZoomControlStyle.SMALL},
				streetViewControl: false,			  
			});
			
		},
		
		/**
		 * Initialize a Fusion Table Layer
		 * @param id Int The unique fusion table id to load
		 */
		initFusionLayer : function(id){
			var obj = this;
			
			try{
				this.fusion.setMap(null);
			}catch(e){
				//do nothing
			}
			
			this.fusion = new google.maps.FusionTablesLayer({
			query: {
				select: 'geometry',
				from: id, // again, geolocation to replace this with closest one
			},
			suppressInfoWindows: true,
			styles: [{
				polygonOptions: {
					fillColor: "#00FF00",
					fillOpacity: 0.3
					}
				}]
			});
			
			main.fusion.setMap(main.map);
			main.initInfoWindow();
			main.initFusionClickEvent();
		},
		
		/**
		 * Initializes the informaiton window.
		 * @see mapWindow
		 */
		initInfoWindow : function(){
			this.mapWindow = new google.maps.InfoWindow({
				content:"Edit point of interest?<br/><input id='EditPoint' type='button' value='Edit'/>"
			});
		},
		
		/**
		 * Binds the click event for the current fusion table layer
		 */
		initFusionClickEvent : function(){
			//bind the click event to fusion layer
			google.maps.event.addListener(main.fusion, 'click', function(e) {
			
				//set the position of the information window
				//to the clicked on element
				main.mapWindow.setPosition(e.latLng);
				
				//bind the map window to the map
				main.mapWindow.open(main.map);
				
				//alter the class (for display purposes) and bind a click event
				$(main.mapWindow.b.f).addClass('infoWindow')
				.find('#EditPoint').click(function(){
					//holds the original fusion tables values
					var orig = {};
				
					//clean up the HTML data area
					main.htmlRemoveAllRecords();
					
					//get data from fusion or local data store if it exists.
					//pulls from local if it exists, fusion tables otherwise
					var fromFusion = (typeof main.localData.records[e.row.LineID.value] == "undefined");
					var data = (fromFusion) ? e.row : main.localData.records[e.row.LineID.value];
					
					for(var key in dataMap.header){
						try{
							var entry = (fromFusion) ? data[key].value : data[key];
							var field = key;
							
							//set the forms value
							$('#'+field).val(entry);
							
							//update original data
							orig[field] = e.row[key].value;
						} catch(err){
							//do nothing
						}
					}
					
					//cycle through all fusion table data
					//and add the records into the HTML
					for(var key in dataMap.data){
						try{
							var l = (fromFusion) ? data[key + '_L'].value : data[key + '_L'];
							var m = (fromFusion) ? data[key + '_M'].value : data[key + '_M'];
							var h = (fromFusion) ? data[key + '_H'].value : data[key + '_H'];
							var code = dataMap.data[key].code;
							
							if(l != '' || m != '' || h != ''){	
								main.htmlAddRecordData(code,l,m,h,fromFusion);
							}
							
							//add to origional data
							orig[key+'_L'] = e.row[key+'_L'].value;
							orig[key+'_M'] = e.row[key+'_M'].value;
							orig[key+'_H'] = e.row[key+'_H'].value;
							
						} catch(err){
							//do nothing
						}
					}
					
					//update local data
					main.localData.origs[orig.LineID] = orig;
					main.saveState();
					
					//trigger the data tab and then show data-data sub nav
					$('#data').click();
					$('#data-data').click();
				});
				
			});
		}
	};
	//initialize the navigation and basic events
	main.init();
	
	//initialize the map, no fusion stuff
	main.initMap();
	
	//initialize the drop down menu
	main.initHtmlMapOptions();
	
	//bind the map choice drop down list change event
	main.bindHtmlMapChange();
	
	//attempt to position map based on user's location
	main.initLocation();
	
	window.main = main;
});
	
</script>

</body>
</html>